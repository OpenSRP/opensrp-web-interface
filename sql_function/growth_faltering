CREATE OR REPLACE FUNCTION core.growth_faltering (conditions varchar,startDate varchar,endDate varchar) 
RETURNS int
AS $$    
    DECLARE totalCount int:=0; 
    betweenCondition varchar := '';
  
    BEGIN  
    if (startDate != '' AND endDate != '') THEN            
		betweenCondition := betweenCondition || E' and( cg1.last_event_date between \''|| startDate || E'\' and \''
                             || endDate || E'\')';
	END IF;
    	 EXECUTE 'select count(*)
            FROM core."viewJsonDataConversionOfClient" c
            join 
                (SELECT base_entity_id,growth_status,last_event_date
                 FROM core.child_growth cg1
                 WHERE cg1.growth_status=false ' || betweenCondition ||' and NOT EXISTS (
                   SELECT *
                   FROM core.child_growth cg2
                   WHERE cg1.base_entity_id = cg2.base_entity_id
                     AND cg1.last_event_date < cg2.last_event_date
                   ) order by base_entity_id desc
                ) as gf
             on c.base_entity_id = gf.base_entity_id
            WHERE c.event_type =' || E' \'Birth Registration\'' || conditions   INTO totalCount ;
            --- should be changed next to event date 
    return totalCount;
  END;
  $$ LANGUAGE 'plpgsql';