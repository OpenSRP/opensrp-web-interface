CREATE OR REPLACE FUNCTION core.counseled_pregnant_women (conditions varchar,startDate varchar,endDate varchar) 
RETURNS int
AS $$    
    DECLARE totalSize int;
    DECLARE returnVal varchar;
    DECLARE i varchar; 
    DECLARE totalCount int:=0; 
   	DECLARE childs RECORD;
    dateBetweenConditionInClient varchar := '';
    dateBetweenConditionInEvent varchar := '';
    BEGIN  
    if (startDate != '' AND endDate != '') THEN            
		dateBetweenConditionInClient := dateBetweenConditionInClient || E' and( member_reg_date between \''|| startDate || E'\' and \''
                             || endDate || E'\')';
		dateBetweenConditionInEvent := dateBetweenConditionInEvent || E' and( event_date between \''|| startDate || E'\' and \''
                             || endDate || E'\')';
    END IF; 
    FOR childs IN 
		EXECUTE 'SELECT c.base_entity_id as baseEntityId,c.birth_date as dob FROM core."viewJsonDataConversionOfClient" as c  
            WHERE c.event_type =' || E' \'New Woman Member Registration\' ' || conditions
           --  and provider_id='joom'
           -- and base_entity_id ='45520784-1360-4136-842a-b1dcf5e34537'
            
            LOOP        
                EXECUTE 'SELECT count(*) FROM core."viewJsonDataConversionOfEvent" e  
                WHERE e.event_type ='|| E'\'Pregnant Woman Counselling\'                
                and e.base_entity_id ='||E' \''||childs.baseEntityId ||E'\'' || dateBetweenConditionInEvent  into totalSize;
                IF totalSize > 0 
                    THEN
                 totalCount= totalCount+1;           
                END IF;
            END LOOP;
    return totalCount;
  END;
  $$ LANGUAGE 'plpgsql';
  
