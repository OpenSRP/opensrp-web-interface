CREATE OR REPLACE FUNCTION core.severely_underweight (conditions varchar,startDate varchar,endDate varchar) 
RETURNS int
AS $$    
    DECLARE weightDifference float;    
    DECLARE totalCount int:=0; 
   	DECLARE childs RECORD;
    dateBetweenCondition varchar := '';
    clientdateBetweenCondition varchar :='';
    sixTotwentythreeAgedCondition varchar := '';
    BEGIN  
    	if (startDate != '' AND endDate != '') THEN  
        endDate = E'\''|| endDate || E'\'';
        startDate = E'\''||startDate || E'\'';                             
        dateBetweenCondition := dateBetweenCondition || E' and ( cg1.event_date between '|| startDate || ' and '
                             || endDate ||')';                             
        clientdateBetweenCondition := clientdateBetweenCondition || E'  ( birth_date between '|| startDate || ' and '
                             || endDate ||')';
        sixTotwentythreeAgedCondition =' and (
            ( DATE_PART (' || E'\'day\','|| startDate || '::timestamp - c.birth_date::timestamp)>181
                 and  DATE_PART('|| E'\'day\','|| startDate || '::timestamp - c.birth_date::timestamp)<691 and birth_date <'||startDate ||'
                 ) OR ' || clientdateBetweenCondition ||')';
    	ELSE   
        endDate = E'\''||NOW()|| E'\'';
        sixTotwentythreeAgedCondition =' and (
            ( DATE_PART(' || E'\'day\','|| endDate || '::timestamp - c.birth_date::timestamp)>181
                 and DATE_PART('|| E'\'day\','|| endDate || '::timestamp - c.birth_date::timestamp)<691 and birth_date <='|| endDate ||')
            )';
        END IF;
        
    	FOR childs IN         
            EXECUTE 'SELECT c.base_entity_id as baseEntityId,c.birth_date as dob FROM core."viewJsonDataConversionOfClient" as c  
            WHERE c.event_type =' || E' \'Birth Registration\' '|| conditions  || sixTotwentythreeAgedCondition         
           --  and provider_id='joom'
           --  and base_entity_id ='536f5c9a-f953-4514-a40b-dd1a454f9705'
            
            LOOP        
               EXECUTE 'SELECT weight - (SELECT  weight   FROM core.child_growth cg 
    			WHERE cg.base_entity_id=cg1.base_entity_id And cg.event_date<cg1.event_date 
    			ORDER BY event_date DESC  limit 1)  as difference   
				FROM core.child_growth cg1
	 			where base_entity_id =' ||E' \''||childs.baseEntityId ||E'\' '|| dateBetweenCondition ||
                'ORDER BY cg1.event_date desc limit 1'
				 into weightDifference ;
                IF weightDifference < 0 
                    THEN
                 totalCount= totalCount+1;           
                END IF;
            END LOOP;
    return totalCount;
  END;
  $$ LANGUAGE 'plpgsql';
  
  SELECT core.severely_underweight('','2018-02-07','2018-08-15'); 
