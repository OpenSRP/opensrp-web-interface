CREATE OR REPLACE FUNCTION core.severely_underweight (conditions varchar,startDate varchar,endDate varchar) 
RETURNS int
AS $$    
    DECLARE weightDifference float;    
    DECLARE totalCount int:=0; 
   	DECLARE childs RECORD;
    betweenCondition varchar := '';
    BEGIN  
    	if (startDate != '' AND endDate != '') THEN            
		betweenCondition := betweenCondition || E' and( cg.event_date between \''|| startDate || E'\' and \''
                             || endDate || E'\')';
        END IF;
        
    	FOR childs IN         
            EXECUTE 'SELECT c.base_entity_id as baseEntityId,c.birth_date as dob FROM core."viewJsonDataConversionOfClient" as c  
            WHERE c.event_type =' || E' \'Birth Registration\' '|| conditions           
           --  and provider_id='joom'
           --  and base_entity_id ='536f5c9a-f953-4514-a40b-dd1a454f9705'
            
            LOOP        
                weightDifference =  (SELECT weight - (SELECT  weight   FROM core.child_growth b 
    			WHERE b.base_entity_id=t4.base_entity_id And b.event_date<t4.event_date 
    			ORDER BY event_date DESC  limit 1)  as difference   
				FROM core.child_growth t4
	 			where base_entity_id = childs.baseEntityId 
                         ORDER BY t4.event_date desc limit 1
				);
                IF weightDifference < 0 
                    THEN
                 totalCount= totalCount+1;           
                END IF;
            END LOOP;
    return totalCount;
  END;
  $$ LANGUAGE 'plpgsql';
  
